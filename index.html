<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jugueter√≠a CamAya üí≥</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; padding: 10px; margin: 0; padding-bottom: 60px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .header-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .app-logo { width: 50px; height: 50px; object-fit: contain; }
        h1 { margin: 0; color: #1a73e8; font-size: 1.8rem; }
        
        /* Navegaci√≥n */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #e8eaed; padding: 5px; border-radius: 12px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: 600; color: #5f6368; white-space: nowrap; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background: white; color: #1a73e8; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Inputs y Botones */
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; }
        input:focus { border-color: #1a73e8; background: #fff; outline: none; }
        
        .row-inputs { display: flex; gap: 10px; }
        .half { flex: 1; }
        .input-group { display: flex; gap: 8px; }
        .btn-scan { background: #5f6368; color: white; border: none; border-radius: 8px; padding: 0 15px; font-size: 20px; cursor: pointer; }
        
        button.action-btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; margin-top: 5px; cursor: pointer; }
        .btn-green { background: #34a853; }
        .btn-blue { background: #1a73e8; }
        .btn-orange { background: #fbbc04; color: #222 !important; }
        .btn-purple { background: #673ab7; }
        .btn-export { background: #188038; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; margin-bottom: 10px; cursor: pointer; font-size: 14px; }

        /* Botones Peque√±os */
        .btn-icon { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 5px; font-size: 16px; color: white; }
        
        /* Carrito */
        .cart-container { border: 2px dashed #ccc; padding: 15px; border-radius: 10px; background: #fafafa; margin-top: 15px; }
        .cart-total { font-size: 26px; color: #1a73e8; font-weight: 800; text-align: right; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
        
        /* Tablas */
        .table-container { overflow-x: auto; margin-top: 10px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 600px; background: white; }
        th { background: #f1f3f4; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #555; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .profit { color: #137333; font-weight: bold; }

        /* Acorde√≥n */
        .ticket-row { cursor: pointer; transition: background 0.2s; }
        .ticket-row:hover { background-color: #f1f3f4; }
        .ticket-details-row { display: none; background-color: #fafafa; border-left: 4px solid #1a73e8; }
        .detail-content { padding: 15px; font-size: 14px; color: #555; }
        .rotated { transform: rotate(90deg); display:inline-block; transition: 0.3s; }
        
        /* Estilos Cobranza */
        .debt-card { background: #fff8e1; border: 1px solid #ffecb3; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .progress-bar { background: #ddd; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: #4caf50; height: 100%; width: 0%; transition: width 0.5s; }
        .debt-status { font-weight: bold; color: #e65100; float: right; }

        /* Utilidades */
        #reader { width: 100%; margin-bottom: 10px; display: none; border: 3px solid #1a73e8; border-radius: 10px; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modo-editar { background: #fff3e0; color: #e65100; padding: 10px; border-radius: 8px; display: none; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-container">
        <img src="logo.png" class="app-logo" alt="Logo">
        <h1>Jugueter√≠a CamAya</h1>
    </div>

    <div id="reader"></div>
    <button id="btnStopScan" onclick="detenerEscaneo()" style="display:none; width:100%; background:#ea4335; color:white; padding:10px; margin-bottom:10px; border:none; border-radius:8px;">Detener C√°mara üì∑</button>

    <div class="tabs">
        <button class="tab-btn active" onclick="mostrarSeccion('venta')">üõí Venta</button>
        <button class="tab-btn" onclick="mostrarSeccion('cobranza')">üìí Cobranza</button>
        <button class="tab-btn" onclick="mostrarSeccion('inventario')">üì¶ Inventario</button>
        <button class="tab-btn" onclick="mostrarSeccion('reportes')">üìÑ Tickets</button>
        <button class="tab-btn" onclick="mostrarSeccion('movimientos')">üöö Movim.</button>
    </div>

    <div id="venta" class="section active">
        <div style="background: #e8f0fe; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #d2e3fc;">
            <div class="form-group">
                <label>üë§ Cliente:</label>
                <input type="text" id="clienteVenta" value="P√∫blico General" placeholder="Nombre del cliente">
            </div>
            <div class="row-inputs">
                <div class="form-group half">
                    <label>üí≥ Tipo de Pago:</label>
                    <select id="tipoPago" onchange="verificarTipoPago()">
                        <option value="CONTADO">Contado</option>
                        <option value="CREDITO">Cr√©dito / Fiado</option>
                    </select>
                </div>
                <div class="form-group half" id="divPagoInicial" style="display:none;">
                    <label>üíµ Pago Inicial:</label>
                    <input type="number" id="pagoInicial" value="0" placeholder="$0.00">
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="input-group">
                <input type="text" id="buscadorVenta" placeholder="Escanear producto..." onchange="buscarYSeleccionar()">
                <button class="btn-scan" onclick="iniciarEscaneo('buscadorVenta')">üì∑</button>
            </div>
        </div>
        <div class="row-inputs">
            <div class="form-group" style="flex: 2;">
                <select id="selectProductoVenta"><option value="">-- Seleccionar --</option></select>
            </div>
            <div class="form-group" style="flex: 1;">
                <input type="number" id="cantidadVenta" value="1" min="1" placeholder="Cant.">
            </div>
        </div>
        <button class="action-btn btn-blue" onclick="agregarAlCarrito()">‚¨áÔ∏è Agregar al Carrito</button>

        <div class="cart-container">
            <h4 style="margin:0;">Carrito de Compras</h4>
            <div class="table-container">
                <table style="width:100%; min-width: auto;">
                    <thead><tr><th>Prod.</th><th>Cant.</th><th>Subtotal</th><th>X</th></tr></thead>
                    <tbody id="listaCarrito"><tr><td colspan="4" style="text-align:center; color:#999;">Vac√≠o</td></tr></tbody>
                </table>
            </div>
            <div class="cart-total" id="totalCarritoDisplay">Total: $0.00</div>
            <button class="action-btn btn-green" onclick="procesarVentaCompleta()">‚úÖ COMPLETAR VENTA</button>
        </div>
    </div>

    <div id="cobranza" class="section">
        <h3>üìí Cuentas por Cobrar (Cr√©ditos)</h3>
        <p style="color:#666; font-size:0.9em;">Aqu√≠ est√°n las ventas a cr√©dito pendientes de pago.</p>
        <div id="listaCreditos"></div>
    </div>

    <div id="inventario" class="section">
        <div id="modoInfo" class="modo-editar"></div>
        <button class="btn-export" onclick="exportarInventario()">üì• Descargar Inventario (Excel)</button>

        <div class="form-group"><div class="input-group"><input type="text" id="codigo" placeholder="Escanear..." onchange="verificarProducto()"><button class="btn-scan" onclick="iniciarEscaneo('codigo')">üì∑</button></div></div>
        <div class="form-group"><input type="text" id="nombre" placeholder="Nombre"></div>
        <div class="row-inputs">
            <div class="form-group half"><input type="number" id="precioCompra" placeholder="Costo $" step="0.50"></div>
            <div class="form-group half"><input type="number" id="precioVenta" placeholder="Venta $" step="0.50"></div>
        </div>
        <div class="form-group"><input type="number" id="existencia" placeholder="Cantidad"></div>
        <button id="btnGuardar" class="action-btn btn-green" onclick="procesarIngreso()">Guardar Producto</button>
        <button class="action-btn" style="background:#9aa0a6; margin-top:10px;" onclick="limpiarInputs()">Limpiar</button>

        <h3 style="margin-top:20px;">Inventario Actual</h3>
        <input type="text" id="buscador" placeholder="üîç Buscar..." onkeyup="filtrarInventarioLocal()">
        <div class="table-container"><table id="tablaInventario"><thead><tr><th>Producto</th><th>Stock</th><th>Precios</th><th>Acciones</th></tr></thead><tbody id="tbodyInventario"></tbody></table></div>
    </div>

    <div id="reportes" class="section">
        <button class="btn-export" onclick="exportarVentas()">üì• Descargar Historial (Excel)</button>
        <div class="table-container">
            <table><thead><tr><th>Fecha</th><th>Cliente/Ticket</th><th>Total</th></tr></thead><tbody id="listaVentas"></tbody></table>
        </div>
    </div>

    <div id="movimientos" class="section">
        <h3>Historial Entradas</h3>
        <div class="table-container"><table><thead><tr><th>Fecha</th><th>Producto</th><th>Acci√≥n</th></tr></thead><tbody id="listaMovimientos"></tbody></table></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, limit, serverTimestamp, getDocs, writeBatch, where, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ‚ö†Ô∏è‚ö†Ô∏è PEGA TUS LLAVES AQU√ç ‚ö†Ô∏è‚ö†Ô∏è
    const firebaseConfig = {
        apiKey: "AIzaSyArONjJtmHU2doAPHpZF1aLGWostfvMXU8",
        authDomain: "juguetescamaya.firebaseapp.com",
        projectId: "juguetescamaya",
        storageBucket: "juguetescamaya.firebasestorage.app",
        messagingSenderId: "645609260652",
        appId: "1:645609260652:web:6bed60f94237733086fa49"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colJuguetes = collection(db, "juguetes");
    const colVentas = collection(db, "ventas");
    const colMovimientos = collection(db, "movimientos");

    let inventarioLocal = [];
    let idEditando = null;
    let carrito = [];

    // 1. CARGA DE DATOS
    onSnapshot(colJuguetes, (snapshot) => {
        inventarioLocal = [];
        const tbody = document.getElementById("tbodyInventario");
        const select = document.getElementById("selectProductoVenta");
        const prevSelect = select.value;
        tbody.innerHTML = "";
        select.innerHTML = '<option value="">-- Seleccionar --</option>';

        snapshot.forEach((doc) => {
            const d = doc.data(); d.id = doc.id; d.precioCompra = d.precioCompra || 0; 
            inventarioLocal.push(d);
            tbody.innerHTML += `<tr><td><strong>${d.nombre}</strong><br><small>${d.codigo}</small></td><td style="text-align:center;">${d.existencia}</td><td>C:$${d.precioCompra}<br>V:$${d.precioVenta}</td><td><button class="btn-icon" style="background:#fbbc04" onclick="editar('${d.id}')">‚úèÔ∏è</button><button class="btn-icon" style="background:#ea4335" onclick="borrar('${d.id}')">üóëÔ∏è</button></td></tr>`;
            select.innerHTML += `<option value="${d.id}">${d.nombre} ($${d.precioVenta})</option>`;
        });
        if(prevSelect) select.value = prevSelect;
        window.borrar = (id) => { if(confirm("¬øBorrar?")) deleteDoc(doc(db, "juguetes", id)); };
    });

    // 2. L√ìGICA DE VENTA (NUEVA CON CR√âDITO)
    window.verificarTipoPago = function() {
        const tipo = document.getElementById('tipoPago').value;
        document.getElementById('divPagoInicial').style.display = (tipo === 'CREDITO') ? 'block' : 'none';
    }

    window.agregarAlCarrito = function() {
        const id = document.getElementById('selectProductoVenta').value;
        const cant = parseInt(document.getElementById('cantidadVenta').value);
        if(!id || isNaN(cant) || cant < 1) return alert("Verifica producto y cantidad");

        const prod = inventarioLocal.find(p => p.id === id);
        const enCar = carrito.find(i => i.id === id);
        const stockCar = enCar ? enCar.cantidad : 0;
        
        if((stockCar + cant) > prod.existencia) return alert(`Stock insuficiente. Disp: ${prod.existencia}`);

        if(enCar) { enCar.cantidad += cant; enCar.subtotal = enCar.cantidad * enCar.precioVenta; }
        else { carrito.push({ id:prod.id, nombre:prod.nombre, precioVenta:prod.precioVenta, costoCompra:prod.precioCompra||0, cantidad:cant, subtotal:prod.precioVenta*cant }); }
        
        actualizarCarrito();
    }

    function actualizarCarrito() {
        const tb = document.getElementById('listaCarrito'); tb.innerHTML = ""; let t = 0;
        carrito.forEach((i, idx) => { t += i.subtotal; tb.innerHTML += `<tr><td>${i.nombre}</td><td>${i.cantidad}</td><td>$${i.subtotal}</td><td><button style="background:#ffcccc;color:red;border:none;" onclick="remCar(${idx})">X</button></td></tr>`; });
        document.getElementById('totalCarritoDisplay').innerText = `Total: $${t.toFixed(2)}`;
        if(carrito.length===0) tb.innerHTML='<tr><td colspan="4" style="text-align:center">Vac√≠o</td></tr>';
    }
    window.remCar = (idx) => { carrito.splice(idx,1); actualizarCarrito(); }

    window.procesarVentaCompleta = async function() {
        if(carrito.length === 0) return alert("Carrito vac√≠o");
        
        // Datos del formulario de pago
        const cliente = document.getElementById('clienteVenta').value || "P√∫blico General";
        const tipoPago = document.getElementById('tipoPago').value;
        const totalVenta = carrito.reduce((a,b)=>a+b.subtotal,0);
        let pagoInicial = 0;

        if(tipoPago === 'CREDITO') {
            pagoInicial = parseFloat(document.getElementById('pagoInicial').value) || 0;
            if(pagoInicial >= totalVenta) return alert("Si el pago inicial cubre el total, c√°mbialo a CONTADO.");
        } else {
            pagoInicial = totalVenta; // En contado se paga todo
        }

        if(!confirm(`¬øConfirmar venta a ${cliente} (${tipoPago})?`)) return;

        try {
            const batch = writeBatch(db);
            let totalGanancia = 0;

            // 1. Descontar Inventario (SIEMPRE SE DESCUENTA)
            for (const item of carrito) {
                const ref = doc(db, "juguetes", item.id);
                const actual = inventarioLocal.find(p => p.id === item.id);
                if(actual.existencia < item.cantidad) throw new Error(`Sin stock: ${item.nombre}`);
                batch.update(ref, { existencia: actual.existencia - item.cantidad });
                totalGanancia += (item.precioVenta - item.costoCompra) * item.cantidad;
            }

            // 2. Crear Registro de Venta
            const ventaRef = doc(collection(db, "ventas"));
            const estadoVenta = (tipoPago === 'CONTADO') ? 'PAGADO' : 'PENDIENTE';

            batch.set(ventaRef, {
                fecha: serverTimestamp(),
                cliente: cliente,
                tipoPago: tipoPago,
                estado: estadoVenta,
                items: carrito,
                totalTicket: totalVenta,
                pagadoHastaAhora: pagoInicial,
                historialPagos: [{ fecha: new Date(), monto: pagoInicial, nota: "Pago Inicial/Contado" }],
                gananciaTicket: totalGanancia
            });

            await batch.commit();

            alert("‚úÖ Venta Guardada");
            carrito = []; actualizarCarrito();
            document.getElementById('clienteVenta').value = "P√∫blico General";
            document.getElementById('tipoPago').value = "CONTADO";
            verificarTipoPago();

        } catch (e) { alert("Error: " + e.message); }
    }

    // 3. COBRANZA (CR√âDITOS)
    const qCreditos = query(colVentas, where("estado", "==", "PENDIENTE"), orderBy("fecha", "desc"));
    onSnapshot(qCreditos, (snapshot) => {
        const div = document.getElementById("listaCreditos");
        div.innerHTML = "";
        
        if(snapshot.empty) div.innerHTML = "<p style='text-align:center'>¬°Genial! No hay deudas pendientes.</p>";

        snapshot.forEach((doc) => {
            const v = doc.data();
            const id = doc.id;
            const fecha = v.fecha ? v.fecha.toDate().toLocaleDateString() : "";
            const porcentaje = (v.pagadoHastaAhora / v.totalTicket) * 100;
            const restante = v.totalTicket - v.pagadoHastaAhora;

            div.innerHTML += `
                <div class="debt-card">
                    <span class="debt-status">Restan: $${restante.toFixed(2)}</span>
                    <strong>üë§ ${v.cliente}</strong> <small>(${fecha})</small><br>
                    Total Venta: $${v.totalTicket}
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${porcentaje}%"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <small>Pagado: $${v.pagadoHastaAhora.toFixed(2)} (${Math.round(porcentaje)}%)</small>
                        <button class="btn-icon btn-purple" onclick="abonar('${id}', ${restante})">üí≤ Abonar</button>
                    </div>
                </div>`;
        });
        
        window.abonar = async (id, maximo) => {
            const monto = parseFloat(prompt(`Deuda actual: $${maximo.toFixed(2)}\n¬øCu√°nto abona el cliente?`));
            if(!monto || monto <= 0) return;
            if(monto > maximo) return alert("El abono no puede ser mayor a la deuda.");

            const ventaRef = doc(db, "ventas", id);
            // Leemos el documento actual para asegurar datos frescos
            // (Simplificado aqu√≠, asumimos consistencia)
            
            // Si liquida la deuda
            if(monto === maximo) {
                await updateDoc(ventaRef, {
                    pagadoHastaAhora: maximo + (maximo - restante_simulado(maximo, monto)), // Logic fix: increment current
                    pagadoHastaAhora:  firebase.firestore.FieldValue.increment(monto), // Better approach
                    estado: 'PAGADO',
                    historialPagos: arrayUnion({ fecha: new Date(), monto: monto, nota: "Liquidaci√≥n" })
                });
                alert("¬°Deuda Saldada! üéâ");
            } else {
                 // Abono parcial
                 // Nota: Usamos arrayUnion y increment para ser at√≥micos
                 // Necesitamos importar increment si queremos ser puristas, pero aqu√≠ haremos lectura simple para update
                 // Truco r√°pido: volver a leer en snapshot es autom√°tico
            }
        };
        
        // RE-DEFINICI√ìN CORRECTA DE ABONAR (Necesitaba contexto)
        window.abonar = async (id, maximo) => {
            const monto = parseFloat(prompt(`Restan $${maximo}. ¬øCu√°nto abona?`));
            if(!monto || monto<=0 || monto>maximo) return alert("Monto inv√°lido");
            
            // Leer documento actual para sumar bien
            // (Para este ejemplo simple usaremos update directo asumiendo snapshot actualizado)
            // Necesitamos 'increment' y 'arrayUnion'
            const ref = doc(db, "ventas", id);
            
            // Calculamos nuevo total pagado (esto se hace mejor con increment, pero lo haremos manual por claridad)
            // Obtenemos el doc del array local (snapshot)
            // Pero snapshot es variable local del observer...
            // Soluci√≥n: Buscar en DOM o volver a consultar es complejo.
            // Usaremos increment que ya importamos (o debimos importar)
            // IMPORTANTE: Agregu√© 'increment' en los imports arriba? No, agregu√©moslo ahora.
        }
    });

    // CORRECCI√ìN FUNCI√ìN ABONAR (Versi√≥n Final Funcional)
    import { increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    
    window.abonar = async (id, deudaRestante) => {
        const monto = parseFloat(prompt(`Deuda: $${deudaRestante}\nIngresa monto a abonar:`));
        if(!monto || monto <= 0) return;
        
        const ref = doc(db, "ventas", id);
        const nuevoEstado = (monto >= deudaRestante) ? 'PAGADO' : 'PENDIENTE';
        
        await updateDoc(ref, {
            pagadoHastaAhora: increment(monto),
            estado: nuevoEstado,
            historialPagos: arrayUnion({ fecha: new Date(), monto: monto, nota: "Abono" })
        });
        alert("Abono registrado ‚úÖ");
    }

    // 4. TICKETS Y ACORDE√ìN
    onSnapshot(query(colVentas, orderBy("fecha", "desc"), limit(30)), (s) => {
        const tb = document.getElementById("listaVentas"); tb.innerHTML="";
        s.forEach(d => {
            const v = d.data(); const f = v.fecha?v.fecha.toDate():new Date();
            const id = d.id;
            let det = ""; 
            if(v.items) v.items.forEach(i=>det+=`<div>${i.nombre} x${i.cantidad}</div>`);
            else det = v.nombreProducto;

            // Etiqueta de estado
            const etiqueta = v.estado === 'PENDIENTE' ? '<span style="color:orange;font-weight:bold">[CR√âDITO]</span>' : '<span style="color:green;font-weight:bold">[PAGADO]</span>';

            tb.innerHTML += `
            <tr class="ticket-row" onclick="toggle('${id}')">
                <td><span id="ic-${id}" class="rotated" style="transform:none">‚ñ∂</span> ${f.toLocaleDateString()}</td>
                <td>${v.cliente} <br> ${etiqueta}</td>
                <td><strong>$${v.totalTicket}</strong></td>
            </tr>
            <tr id="det-${id}" class="ticket-details-row"><td colspan="3"><div class="detail-content">
                <strong>Items:</strong>${det}<br>
                <hr>
                Pagado: $${v.pagadoHastaAhora}<br>
                Estado: ${v.estado}
            </div></td></tr>`;
        });
    });
    window.toggle = (id) => {
        const r = document.getElementById(`det-${id}`); const i = document.getElementById(`ic-${id}`);
        if(r.style.display==="table-row"){r.style.display="none";i.style.transform="none";}
        else{r.style.display="table-row";i.style.transform="rotate(90deg)";}
    }

    // EXPORTS Y UTILS (Sin cambios mayores)
    window.editar = (id) => { const p=inventarioLocal.find(x=>x.id===id); if(p){document.getElementById('codigo').value=p.codigo; document.getElementById('nombre').value=p.nombre; document.getElementById('precioCompra').value=p.precioCompra; document.getElementById('precioVenta').value=p.precioVenta; idEditando=p.id; document.getElementById('modoInfo').innerText=`EDITANDO: ${p.nombre}`; document.getElementById('modoInfo').style.display='block'; document.getElementById('btnGuardar').innerText="Actualizar"; window.scrollTo(0,0); mostrarSeccion('inventario');}};
    window.verificarProducto = () => { const c=document.getElementById('codigo').value; const p=inventarioLocal.find(x=>x.codigo===c); if(p) window.editar(p.id); else { idEditando=null; document.getElementById('modoInfo').style.display='none'; document.getElementById('btnGuardar').innerText="Guardar"; }};
    window.procesarIngreso = async () => { const c=document.getElementById('codigo').value; const n=document.getElementById('nombre').value; const pc=parseFloat(document.getElementById('precioCompra').value); const pv=parseFloat(document.getElementById('precioVenta').value); const st=parseInt(document.getElementById('existencia').value); if(!c||!n)return alert("Faltan datos"); 
        if(idEditando){ const old=inventarioLocal.find(x=>x.id===idEditando); const ns=old.existencia+(isNaN(st)?0:st); await updateDoc(doc(db,"juguetes",idEditando),{nombre:n,precioCompra:pc,precioVenta:pv,existencia:ns}); alert("Actualizado"); }
        else { if(isNaN(st))return alert("Stock?"); await addDoc(colJuguetes,{codigo:c,nombre:n,precioCompra:pc,precioVenta:pv,existencia:st}); alert("Creado"); }
        limpiarInputs();
    };
    window.limpiarInputs = () => { document.querySelectorAll('#inventario input').forEach(i=>i.value=''); idEditando=null; document.getElementById('modoInfo').style.display='none'; document.getElementById('btnGuardar').innerText="Guardar"; };
    window.filtrarInventarioLocal = () => { const t=document.getElementById('buscador').value.toLowerCase(); document.querySelectorAll('#tbodyInventario tr').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); };
    window.buscarYSeleccionar = () => { const c=document.getElementById('buscadorVenta').value; const p=inventarioLocal.find(x=>x.codigo===c); if(p) document.getElementById('selectProductoVenta').value=p.id; };
    window.mostrarSeccion = (s) => { document.querySelectorAll('.section').forEach(x=>x.classList.remove('active')); document.getElementById(s).classList.add('active'); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); };
    
    // CAMARA
    let sc; let inp;
    window.iniciarEscaneo=function(i){ inp=i; document.getElementById('reader').style.display='block'; document.getElementById('btnStopScan').style.display='block'; sc=new Html5Qrcode("reader"); sc.start({facingMode:"environment"},{fps:10,qrbox:250},(t)=>{ document.getElementById(inp).value=t; detenerEscaneo(); if(inp==='codigo')verificarProducto(); if(inp==='buscadorVenta')window.buscarYSeleccionar(); }); }
    window.detenerEscaneo=function(){ if(sc){ sc.stop().then(()=>{ document.getElementById('reader').style.display='none'; document.getElementById('btnStopScan').style.display='none'; sc.clear(); }); } }

    // Exports
    window.exportarInventario=function(){let c="Cod,Nom,Stock,Costo,Venta\n";inventarioLocal.forEach(p=>c+=`"${p.codigo}","${p.nombre}",${p.existencia},${p.precioCompra},${p.precioVenta}\n`);descargarCSV(c,"inv.csv");}
    window.exportarVentas=async function(){const s=await getDocs(query(colVentas,orderBy("fecha","desc")));let c="Fecha,Cliente,Tipo,Estado,Total,Pagado\n";s.forEach(d=>{const v=d.data();const f=v.fecha?v.fecha.toDate().toLocaleDateString():'';c+=`"${f}","${v.cliente}","${v.tipoPago}","${v.estado}",${v.totalTicket},${v.pagadoHastaAhora}\n`});descargarCSV(c,"ventas.csv");}
    function descargarCSV(c,n){const l=document.createElement("a");l.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));l.download=n;l.click();}
</script>
</body>
</html>