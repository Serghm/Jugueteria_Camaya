<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jugueter√≠a Pro üöÄ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* ESTILOS (Mejorados) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; padding: 15px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a73e8; font-size: 24px; margin-bottom: 20px; }
        
        /* Navegaci√≥n */
        .tabs { display: flex; justify-content: space-around; margin-bottom: 20px; background: #f1f3f4; padding: 5px; border-radius: 25px; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; background: transparent; border: none; border-radius: 20px; font-weight: 600; color: #5f6368; transition: 0.3s; }
        .tab-btn.active { background: #fff; color: #1a73e8; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Inputs y Botones */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; font-size: 14px; }
        input, select { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #f8f9fa; }
        input:focus { border-color: #1a73e8; outline: none; background: #fff; }
        
        .input-group { display: flex; gap: 8px; }
        .btn-scan { background: #5f6368; color: white; border: none; border-radius: 10px; padding: 0 15px; font-size: 22px; cursor: pointer; }
        
        button.action-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; transition: transform 0.1s; }
        button.action-btn:active { transform: scale(0.98); }
        
        /* Colores de botones */
        .btn-green { background: #34a853; } /* Guardar */
        .btn-blue { background: #1a73e8; }  /* Vender */
        .btn-orange { background: #fbbc04; color: #333 !important; } /* Actualizar */

        /* C√°mara */
        #reader { width: 100%; margin-bottom: 15px; display: none; border-radius: 12px; overflow: hidden; border: 3px solid #1a73e8; }
        
        /* Tablas */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; min-width: 500px; }
        th { background-color: #f8f9fa; padding: 12px; text-align: left; color: #555; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        /* Estados */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .low-stock { color: #d93025; font-weight: 800; background: #fce8e6; padding: 2px 6px; border-radius: 4px; }
        .money { color: #188038; font-weight: bold; }
        
        /* Info Mode (Para saber si estamos editando o creando) */
        #modoInfo { display: none; padding: 10px; margin-bottom: 10px; border-radius: 8px; text-align: center; font-weight: bold; }
        .modo-nuevo { background-color: #e6f4ea; color: #137333; }
        .modo-editar { background-color: #fef7e0; color: #b06000; }
    </style>
</head>
<body>

<div class="container">
    <h1>üß∏ Jugueter√≠a Camaya</h1>

    <div id="reader"></div>
    <button id="btnStopScan" onclick="detenerEscaneo()" style="display:none; width:100%; background:#ea4335; color:white; padding:12px; margin-bottom:15px; border:none; border-radius:10px;">Cerrar C√°mara ‚ùå</button>

    <div class="tabs">
        <button class="tab-btn active" onclick="mostrarSeccion('inventario')">üì¶ Inventario</button>
        <button class="tab-btn" onclick="mostrarSeccion('venta')">üí∞ Venta</button>
        <button class="tab-btn" onclick="mostrarSeccion('reportes')">üìä Historial</button>
    </div>

    <div id="inventario" class="section active">
        
        <div id="modoInfo"></div> <div class="form-group">
            <label>C√≥digo de Barras:</label>
            <div class="input-group">
                <input type="text" id="codigo" placeholder="Escanea para crear o reabastecer" onchange="verificarProducto()">
                <button class="btn-scan" onclick="iniciarEscaneo('codigo')">üì∑</button>
            </div>
        </div>
        
        <div class="form-group">
            <label>Nombre del Juguete:</label>
            <input type="text" id="nombre" placeholder="Ej. Pelota Gigante">
        </div>
        
        <div class="form-group">
            <label>Precio de Venta ($):</label>
            <input type="number" id="precioVenta" placeholder="0.00">
        </div>

        <div class="form-group">
            <label id="labelExistencia">Cantidad a Ingresar:</label>
            <input type="number" id="existencia" placeholder="Cantidad que lleg√≥">
            <small id="stockActualHelp" style="display:none; color:#666;">(Se sumar√° al stock actual)</small>
        </div>

        <button id="btnGuardar" class="action-btn btn-green" onclick="procesarIngreso()">Guardar Nuevo Producto</button>
        <button class="action-btn" style="background:#888; margin-top:10px;" onclick="limpiarInputs()">Limpiar Formulario</button>

        <h3>Inventario Actual</h3>
        <div class="input-group" style="margin-bottom:10px;">
             <input type="text" id="buscador" placeholder="üîç Buscar por nombre..." onkeyup="filtrarInventarioLocal()">
        </div>
        
        <div class="table-container">
            <table id="tablaInventario">
                <thead><tr><th>Producto</th><th>Stock</th><th>Precio</th><th>X</th></tr></thead>
                <tbody id="listaProductos"></tbody>
            </table>
        </div>
    </div>

    <div id="venta" class="section">
        <div class="form-group" style="text-align:center; padding:20px; background:#e8f0fe; border-radius:10px;">
            <h2 id="totalVentaDisplay" style="margin:0; color:#1a73e8; font-size:40px;">$0.00</h2>
            <small>Total a Cobrar</small>
        </div>

        <div class="form-group">
            <label>Escanear Producto:</label>
            <div class="input-group">
                <input type="text" id="buscadorVenta" placeholder="C√≥digo..." onchange="buscarYSeleccionar()">
                <button class="btn-scan" onclick="iniciarEscaneo('buscadorVenta')">üì∑</button>
            </div>
        </div>

        <div class="form-group">
            <select id="selectProductoVenta" onchange="calcularTotalPreview()">
                <option value="">-- Esperando producto --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Cantidad:</label>
            <input type="number" id="cantidadVenta" value="1" min="1" onchange="calcularTotalPreview()">
        </div>

        <button class="action-btn btn-blue" onclick="venderEnNube()">‚úÖ Confirmar Venta</button>
    </div>

    <div id="reportes" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>Ventas Recientes</h3>
            <div style="text-align:right;">
                <small>Total Vendido Hoy</small><br>
                <span id="totalDia" class="money" style="font-size:20px;">$0.00</span>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead><tr><th>Hora</th><th>Producto</th><th>Cant.</th><th>Total</th></tr></thead>
                <tbody id="listaVentas"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ‚ö†Ô∏è‚ö†Ô∏è PEGA TU CONFIGURACI√ìN DE FIREBASE AQU√ç ‚ö†Ô∏è‚ö†Ô∏è
    const firebaseConfig = {
  apiKey: "AIzaSyArONjJtmHU2doAPHpZF1aLGWostfvMXU8",
  authDomain: "juguetescamaya.firebaseapp.com",
  projectId: "juguetescamaya",
  storageBucket: "juguetescamaya.firebasestorage.app",
  messagingSenderId: "645609260652",
  appId: "1:645609260652:web:6bed60f94237733086fa49"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Referencias a colecciones
    const colJuguetes = collection(db, "juguetes");
    const colVentas = collection(db, "ventas");

    let inventarioLocal = [];
    let idProductoEditando = null; // Para saber si estamos reabasteciendo

    // 1. ESCUCHAR INVENTARIO (Lectura)
    onSnapshot(colJuguetes, (snapshot) => {
        inventarioLocal = [];
        const listaHTML = document.getElementById("listaProductos");
        const selectVenta = document.getElementById("selectProductoVenta");
        
        listaHTML.innerHTML = "";
        const seleccionPrevia = selectVenta.value;
        selectVenta.innerHTML = '<option value="">-- Seleccionar --</option>';

        snapshot.forEach((doc) => {
            const data = doc.data();
            data.id = doc.id;
            inventarioLocal.push(data);

            // Fila Inventario
            listaHTML.innerHTML += `
                <tr>
                    <td><strong>${data.nombre}</strong><br><small style="color:#888">${data.codigo}</small></td>
                    <td class="${data.existencia < 5 ? 'low-stock' : ''}" style="text-align:center">${data.existencia}</td>
                    <td>$${data.precioVenta}</td>
                    <td><button style="color:red; border:none; background:none; font-size:16px;" onclick="borrarProducto('${data.id}')">üóëÔ∏è</button></td>
                </tr>`;

            // Opci√≥n Venta
            selectVenta.innerHTML += `<option value="${data.id}" data-precio="${data.precioVenta}">${data.nombre}</option>`;
        });
        
        // Restaurar selecci√≥n y re-asignar eventos de borrado
        if(seleccionPrevia) selectVenta.value = seleccionPrevia;
        window.borrarProducto = (id) => { if(confirm("¬øBorrar?")) deleteDoc(doc(db, "juguetes", id)); };
    });

    // 2. ESCUCHAR VENTAS (Reportes)
    // Ordenamos por fecha descendente (lo m√°s nuevo arriba) y limitamos a las √∫ltimas 50
    const qVentas = query(colVentas, orderBy("fecha", "desc"), limit(50));
    
    onSnapshot(qVentas, (snapshot) => {
        const listaVentas = document.getElementById("listaVentas");
        listaVentas.innerHTML = "";
        let totalHoy = 0;
        const hoyString = new Date().toLocaleDateString();

        snapshot.forEach((doc) => {
            const v = doc.data();
            const fechaObj = v.fecha ? v.fecha.toDate() : new Date();
            
            // Sumar al total si es de hoy
            if(fechaObj.toLocaleDateString() === hoyString) {
                totalHoy += v.total;
            }

            listaVentas.innerHTML += `
                <tr>
                    <td>${fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>${v.nombreProducto}</td>
                    <td style="text-align:center">${v.cantidad}</td>
                    <td class="money">$${v.total}</td>
                </tr>`;
        });
        document.getElementById("totalDia").innerText = `$${totalHoy.toFixed(2)}`;
    });

    // 3. L√ìGICA DE INGRESO / REABASTECIMIENTO
    window.verificarProducto = function() {
        const codigo = document.getElementById('codigo').value;
        const encontrado = inventarioLocal.find(j => j.codigo === codigo);
        
        const modoDiv = document.getElementById('modoInfo');
        const btn = document.getElementById('btnGuardar');
        const help = document.getElementById('stockActualHelp');

        if (encontrado) {
            // MODO EDICI√ìN / REABASTECER
            idProductoEditando = encontrado.id;
            
            document.getElementById('nombre').value = encontrado.nombre;
            document.getElementById('precioVenta').value = encontrado.precioVenta;
            document.getElementById('existencia').value = ''; // Se deja vac√≠o para que ingrese SOLO lo nuevo
            
            modoDiv.innerText = `üîÑ REABASTECIENDO: ${encontrado.nombre} (Stock actual: ${encontrado.existencia})`;
            modoDiv.className = 'modo-editar';
            modoDiv.style.display = 'block';
            
            btn.innerText = "üîÑ Sumar Stock y Actualizar Precio";
            btn.className = "action-btn btn-orange";
            help.style.display = "block";
        } else {
            // MODO NUEVO
            idProductoEditando = null;
            modoDiv.innerText = "‚ú® REGISTRANDO NUEVO PRODUCTO";
            modoDiv.className = 'modo-nuevo';
            modoDiv.style.display = 'block';
            
            btn.innerText = "üíæ Guardar Nuevo Producto";
            btn.className = "action-btn btn-green";
            help.style.display = "none";
            
            // Limpiar otros campos si cambiamos de c√≥digo
            if(document.getElementById('nombre').value === '') {
                 // Solo limpiar si no hab√≠a escrito algo manualmente
            }
        }
    }

    window.procesarIngreso = async function() {
        const codigo = document.getElementById('codigo').value;
        const nombre = document.getElementById('nombre').value;
        const precio = parseFloat(document.getElementById('precioVenta').value);
        const stockInput = parseInt(document.getElementById('existencia').value);

        if(!codigo || !nombre || isNaN(precio) || isNaN(stockInput)) {
            alert("Por favor completa todos los datos correctamente.");
            return;
        }

        try {
            if (idProductoEditando) {
                // ACTUALIZAR EXISTENTE
                const productoOld = inventarioLocal.find(j => j.id === idProductoEditando);
                const nuevoStockTotal = productoOld.existencia + stockInput;
                
                await updateDoc(doc(db, "juguetes", idProductoEditando), {
                    nombre: nombre,
                    precioVenta: precio,
                    existencia: nuevoStockTotal
                });
                alert(`‚úÖ Stock actualizado. Nuevo total: ${nuevoStockTotal}`);
            } else {
                // CREAR NUEVO
                if(inventarioLocal.some(j => j.codigo === codigo)) return alert("Error raro: El c√≥digo ya existe.");
                
                await addDoc(colJuguetes, {
                    codigo, nombre, precioVenta: precio, existencia: stockInput
                });
                alert("‚úÖ Producto registrado correctamente");
            }
            limpiarInputs();
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    // 4. L√ìGICA DE VENTA Y REGISTRO EN HISTORIAL
    window.venderEnNube = async function() {
        const id = document.getElementById('selectProductoVenta').value;
        const cantidad = parseInt(document.getElementById('cantidadVenta').value);
        
        if(!id) return alert("Selecciona un juguete");

        const juguete = inventarioLocal.find(j => j.id === id);
        
        if(juguete.existencia >= cantidad) {
            const totalVenta = juguete.precioVenta * cantidad;
            
            try {
                // A) Restar inventario
                await updateDoc(doc(db, "juguetes", id), {
                    existencia: juguete.existencia - cantidad
                });

                // B) Guardar en historial (NUEVO)
                await addDoc(colVentas, {
                    fecha: serverTimestamp(), // Hora del servidor
                    idProducto: id,
                    nombreProducto: juguete.nombre,
                    cantidad: cantidad,
                    total: totalVenta
                });

                alert(`¬°Venta exitosa! üí∞ $${totalVenta}`);
                document.getElementById('cantidadVenta').value = 1;
                document.getElementById('totalVentaDisplay').innerText = "$0.00";
            } catch (e) {
                alert("Error procesando venta: " + e.message);
            }
        } else {
            alert("‚ùå No hay suficiente stock para esta venta");
        }
    }

    // Funciones visuales
    window.calcularTotalPreview = function() {
        const select = document.getElementById('selectProductoVenta');
        const cantidad = document.getElementById('cantidadVenta').value;
        const precio = select.options[select.selectedIndex]?.dataset.precio || 0;
        const total = precio * cantidad;
        document.getElementById('totalVentaDisplay').innerText = `$${total.toFixed(2)}`;
    }

    window.limpiarInputs = function() {
        document.getElementById('codigo').value = '';
        document.getElementById('nombre').value = '';
        document.getElementById('precioVenta').value = '';
        document.getElementById('existencia').value = '';
        document.getElementById('modoInfo').style.display = 'none';
        document.getElementById('btnGuardar').className = "action-btn btn-green";
        document.getElementById('btnGuardar').innerText = "Guardar Nuevo Producto";
        idProductoEditando = null;
    }

    window.filtrarInventarioLocal = function() {
        const t = document.getElementById('buscador').value.toLowerCase();
        document.querySelectorAll('#listaProductos tr').forEach(r => {
            r.style.display = r.innerText.toLowerCase().includes(t) ? '' : 'none';
        });
    }

    window.buscarYSeleccionar = function() {
        const codigo = document.getElementById('buscadorVenta').value;
        const encontrado = inventarioLocal.find(j => j.codigo === codigo);
        if(encontrado) {
            document.getElementById('selectProductoVenta').value = encontrado.id;
            window.calcularTotalPreview();
        }
    }
</script>

<script>
    // C√ÅMARA (L√≥gica externa para evitar conflictos de import)
    let html5QrcodeScanner;
    let inputActual = '';

    function iniciarEscaneo(idInput) {
        inputActual = idInput;
        document.getElementById('reader').style.display = 'block';
        document.getElementById('btnStopScan').style.display = 'block';
        
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                document.getElementById(inputActual).value = decodedText;
                detenerEscaneo();
                // Disparar eventos manualmente
                if(inputActual === 'codigo') window.verificarProducto();
                if(inputActual === 'buscadorVenta') window.buscarYSeleccionar();
            }
        );
    }

    function detenerEscaneo() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('reader').style.display = 'none';
                document.getElementById('btnStopScan').style.display = 'none';
                html5QrcodeScanner.clear();
            });
        }
    }
    
    function mostrarSeccion(sec) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(sec).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        // L√≥gica de botones activos
        const map = {'inventario':0, 'venta':1, 'reportes':2};
        document.querySelectorAll('.tab-btn')[map[sec]].classList.add('active');
    }
</script>

</body>
</html>