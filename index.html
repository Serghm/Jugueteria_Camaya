<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jugueter√≠a CamAya üõí</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; padding: 10px; margin: 0; padding-bottom: 50px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Encabezado con Logo */
        .header-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .app-logo { width: 50px; height: 50px; object-fit: contain; }
        h1 { margin: 0; color: #1a73e8; font-size: 1.8rem; }
        
        /* Navegaci√≥n (Pesta√±as) */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #e8eaed; padding: 5px; border-radius: 12px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: 600; color: #5f6368; white-space: nowrap; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background: white; color: #1a73e8; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Formularios e Inputs */
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; }
        input:focus { border-color: #1a73e8; background: #fff; outline: none; }
        
        .row-inputs { display: flex; gap: 10px; }
        .half { flex: 1; }
        .input-group { display: flex; gap: 8px; }
        
        /* Botones de Acci√≥n */
        .btn-scan { background: #5f6368; color: white; border: none; border-radius: 8px; padding: 0 15px; font-size: 20px; cursor: pointer; }
        button.action-btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; margin-top: 5px; cursor: pointer; transition: transform 0.1s; }
        button.action-btn:active { transform: scale(0.98); }
        
        .btn-green { background: #34a853; }
        .btn-blue { background: #1a73e8; }
        .btn-orange { background: #fbbc04; color: #222 !important; }
        .btn-red { background: #ea4335; }
        .btn-export { background: #188038; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; margin-bottom: 10px; cursor: pointer; font-size: 14px; }

        /* Botones de Tabla (Editar/Borrar) */
        .btn-edit { background-color: #fbbc04; color: #222; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 5px; font-size: 16px; }
        .btn-delete { background-color: #ea4335; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 16px; }

        /* Carrito de Compras */
        .cart-container { border: 2px dashed #ccc; padding: 15px; border-radius: 10px; background: #fafafa; margin-top: 15px; }
        .cart-total { font-size: 26px; color: #1a73e8; font-weight: 800; text-align: right; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
        .btn-remove { background: #ffcccc; color: #d32f2f; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* Tablas Responsive */
        .table-container { overflow-x: auto; margin-top: 10px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 600px; background: white; }
        th { background: #f1f3f4; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #555; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .profit { color: #137333; font-weight: bold; }
        .cost { color: #ea4335; font-size: 0.9em; }
        
        /* C√°mara y Utilidades */
        #reader { width: 100%; margin-bottom: 10px; display: none; border: 3px solid #1a73e8; border-radius: 10px; overflow: hidden; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modo-editar { background: #fff3e0; color: #e65100; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; text-align: center; font-weight: bold; border: 1px solid #ffe0b2; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-container">
        <img src="https://cdn-icons-png.flaticon.com/512/3081/3081840.png" class="app-logo" alt="Logo">
        <h1>Jugueter√≠a POS</h1>
    </div>

    <div id="reader"></div>
    <button id="btnStopScan" onclick="detenerEscaneo()" style="display:none; width:100%; background:#ea4335; color:white; padding:10px; margin-bottom:10px; border:none; border-radius:8px;">Detener C√°mara üì∑</button>

    <div class="tabs">
        <button class="tab-btn active" onclick="mostrarSeccion('venta')">üõí Venta</button>
        <button class="tab-btn" onclick="mostrarSeccion('inventario')">üì¶ Inventario</button>
        <button class="tab-btn" onclick="mostrarSeccion('reportes')">üìÑ Tickets</button>
        <button class="tab-btn" onclick="mostrarSeccion('movimientos')">üöö Historial</button>
    </div>

    <div id="venta" class="section active">
        <div class="form-group">
            <div class="input-group">
                <input type="text" id="buscadorVenta" placeholder="Escanear producto..." onchange="buscarYSeleccionar()">
                <button class="btn-scan" onclick="iniciarEscaneo('buscadorVenta')">üì∑</button>
            </div>
        </div>

        <div class="row-inputs">
            <div class="form-group" style="flex: 2;">
                <select id="selectProductoVenta"><option value="">-- Seleccionar --</option></select>
            </div>
            <div class="form-group" style="flex: 1;">
                <input type="number" id="cantidadVenta" value="1" min="1" placeholder="Cant.">
            </div>
        </div>
        <button class="action-btn btn-blue" onclick="agregarAlCarrito()">‚¨áÔ∏è Agregar al Carrito</button>

        <div class="cart-container">
            <h4 style="margin-top:0;">Lista de Compra</h4>
            <div class="table-container">
                <table style="width:100%; min-width: auto;">
                    <thead><tr><th>Prod.</th><th>Cant.</th><th>Subtotal</th><th>X</th></tr></thead>
                    <tbody id="listaCarrito">
                        <tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">El carrito est√° vac√≠o</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="cart-total" id="totalCarritoDisplay">Total: $0.00</div>
            <button class="action-btn btn-green" onclick="procesarVentaCompleta()">‚úÖ COBRAR TICKET</button>
        </div>
    </div>

    <div id="inventario" class="section">
        <div id="modoInfo" class="modo-editar"></div>
        <button class="btn-export" onclick="exportarInventario()">üì• Descargar Inventario (Excel)</button>

        <div class="form-group">
            <label>C√≥digo de Barras:</label>
            <div class="input-group">
                <input type="text" id="codigo" placeholder="Escanear o escribir..." onchange="verificarProducto()">
                <button class="btn-scan" onclick="iniciarEscaneo('codigo')">üì∑</button>
            </div>
        </div>
        <div class="form-group"><label>Nombre del Juguete:</label><input type="text" id="nombre"></div>
        <div class="row-inputs">
            <div class="form-group half"><label>Costo Compra ($):</label><input type="number" id="precioCompra" placeholder="0.00" step="0.50"></div>
            <div class="form-group half"><label>Precio Venta ($):</label><input type="number" id="precioVenta" placeholder="0.00" step="0.50"></div>
        </div>
        <div class="form-group"><label>Cantidad a Ingresar:</label><input type="number" id="existencia" placeholder="Stock nuevo"></div>

        <button id="btnGuardar" class="action-btn btn-green" onclick="procesarIngreso()">Guardar Producto</button>
        <button class="action-btn" style="background:#9aa0a6; margin-top:10px;" onclick="limpiarInputs()">Limpiar Formulario</button>

        <h3 style="margin-top:25px; border-bottom:2px solid #eee; padding-bottom:10px;">Inventario Actual</h3>
        <input type="text" id="buscador" placeholder="üîç Buscar por nombre..." onkeyup="filtrarInventarioLocal()">
        
        <div class="table-container">
            <table id="tablaInventario">
                <thead><tr><th>Producto</th><th>Stock</th><th>Costos</th><th>Acciones</th></tr></thead>
                <tbody id="tbodyInventario"></tbody>
            </table>
        </div>
    </div>

    <div id="reportes" class="section">
        <button class="btn-export" onclick="exportarVentas()">üì• Descargar Historial Completo (Excel)</button>
        <div style="background:#e6f4ea; padding:15px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <small>Venta Total Hoy</small><br>
                <span id="totalDia" style="font-size:22px; font-weight:bold; color:#1a73e8;">$0.00</span>
            </div>
            <div style="text-align:right;">
                <small>Ganancia Neta</small><br>
                <span id="gananciaDia" class="profit" style="font-size:22px;">$0.00</span>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Hora</th><th>Detalle del Ticket</th><th>Total</th></tr></thead>
                <tbody id="listaVentas"></tbody>
            </table>
        </div>
    </div>

    <div id="movimientos" class="section">
        <h3>Historial de Entradas</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>Fecha</th><th>Producto</th><th>Acci√≥n</th></tr></thead>
                <tbody id="listaMovimientos"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, limit, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ------------------------------------------------------------------
    // ‚ö†Ô∏è‚ö†Ô∏è PEGA TUS LLAVES AQU√ç ‚ö†Ô∏è‚ö†Ô∏è
    const firebaseConfig = {
  apiKey: "AIzaSyArONjJtmHU2doAPHpZF1aLGWostfvMXU8",
  authDomain: "juguetescamaya.firebaseapp.com",
  projectId: "juguetescamaya",
  storageBucket: "juguetescamaya.firebasestorage.app",
  messagingSenderId: "645609260652",
  appId: "1:645609260652:web:6bed60f94237733086fa49"
};
    // ------------------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colJuguetes = collection(db, "juguetes");
    const colVentas = collection(db, "ventas");
    const colMovimientos = collection(db, "movimientos");

    let inventarioLocal = [];
    let idEditando = null;
    let carrito = [];

    // 1. CARGAR INVENTARIO (CON BOT√ìN DE EDITAR)
    onSnapshot(colJuguetes, (snapshot) => {
        inventarioLocal = [];
        const tbody = document.getElementById("tbodyInventario");
        const select = document.getElementById("selectProductoVenta");
        const prevSelect = select.value;

        tbody.innerHTML = "";
        select.innerHTML = '<option value="">-- Seleccionar --</option>';

        snapshot.forEach((doc) => {
            const d = doc.data();
            d.id = doc.id;
            d.precioCompra = d.precioCompra || 0; 
            inventarioLocal.push(d);

            tbody.innerHTML += `
                <tr>
                    <td><strong>${d.nombre}</strong><br><small style="color:#666">${d.codigo}</small></td>
                    <td style="font-weight:bold; text-align:center;">${d.existencia}</td>
                    <td><span class="cost">C: $${d.precioCompra}</span><br><strong>V: $${d.precioVenta}</strong></td>
                    <td>
                        <button class="btn-edit" onclick="editarDesdeTabla('${d.id}')">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="borrarProducto('${d.id}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            select.innerHTML += `<option value="${d.id}">${d.nombre} ($${d.precioVenta})</option>`;
        });
        if(prevSelect) select.value = prevSelect;
        
        window.borrarProducto = (id) => { if(confirm("¬øEst√°s seguro de borrar este producto permanentemente?")) deleteDoc(doc(db, "juguetes", id)); };
    });

    // 2. L√ìGICA DEL CARRITO (POS)
    window.agregarAlCarrito = function() {
        const id = document.getElementById('selectProductoVenta').value;
        const cant = parseInt(document.getElementById('cantidadVenta').value);
        
        if(!id) return alert("Selecciona un producto primero.");
        if(isNaN(cant) || cant < 1) return alert("Cantidad inv√°lida.");

        const prod = inventarioLocal.find(p => p.id === id);
        
        // Validar Stock
        const enCarrito = carrito.find(item => item.id === id);
        const cantidadEnCarrito = enCarrito ? enCarrito.cantidad : 0;

        if((cantidadEnCarrito + cant) > prod.existencia) {
            return alert(`¬°Stock insuficiente! Tienes ${prod.existencia}, intentas vender ${cantidadEnCarrito + cant}.`);
        }

        if(enCarrito) {
            enCarrito.cantidad += cant;
            enCarrito.subtotal = enCarrito.cantidad * enCarrito.precioVenta;
        } else {
            carrito.push({
                id: prod.id,
                codigo: prod.codigo,
                nombre: prod.nombre,
                precioVenta: prod.precioVenta,
                costoCompra: prod.precioCompra || 0,
                cantidad: cant,
                subtotal: prod.precioVenta * cant
            });
        }
        
        actualizarVistaCarrito();
        document.getElementById('cantidadVenta').value = 1;
        document.getElementById('selectProductoVenta').value = "";
        document.getElementById('buscadorVenta').value = "";
    }

    window.eliminarDelCarrito = function(index) {
        carrito.splice(index, 1);
        actualizarVistaCarrito();
    }

    function actualizarVistaCarrito() {
        const tbody = document.getElementById('listaCarrito');
        const totalDisplay = document.getElementById('totalCarritoDisplay');
        tbody.innerHTML = "";
        let total = 0;

        if(carrito.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">El carrito est√° vac√≠o</td></tr>';
        } else {
            carrito.forEach((item, index) => {
                total += item.subtotal;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.nombre}</td>
                        <td>${item.cantidad}</td>
                        <td>$${item.subtotal.toFixed(2)}</td>
                        <td><button class="btn-remove" onclick="eliminarDelCarrito(${index})">X</button></td>
                    </tr>`;
            });
        }
        totalDisplay.innerText = `Total Ticket: $${total.toFixed(2)}`;
    }

    // 3. COBRAR TICKET (Batch Write)
    window.procesarVentaCompleta = async function() {
        if(carrito.length === 0) return alert("El carrito est√° vac√≠o");
        if(!confirm(`¬øConfirmar venta por $${carrito.reduce((a,b)=>a+b.subtotal,0).toFixed(2)}?`)) return;

        try {
            const batch = writeBatch(db);
            let totalVenta = 0;
            let totalGanancia = 0;
            
            for (const item of carrito) {
                const prodRef = doc(db, "juguetes", item.id);
                // Validaci√≥n simple de stock basada en copia local
                const prodActual = inventarioLocal.find(p => p.id === item.id);
                if(prodActual.existencia < item.cantidad) throw new Error(`Stock insuficiente para ${item.nombre}`);
                
                batch.update(prodRef, { "existencia": prodActual.existencia - item.cantidad });
                totalVenta += item.subtotal;
                totalGanancia += (item.precioVenta - item.costoCompra) * item.cantidad;
            }

            const ventaRef = doc(collection(db, "ventas"));
            batch.set(ventaRef, {
                fecha: serverTimestamp(),
                items: carrito,
                totalTicket: totalVenta,
                gananciaTicket: totalGanancia
            });

            await batch.commit();

            alert("‚úÖ Venta Exitosa");
            carrito = [];
            actualizarVistaCarrito();
            
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    // 4. LOGICA DE INGRESO Y EDICI√ìN
    window.editarDesdeTabla = function(id) {
        const prod = inventarioLocal.find(p => p.id === id);
        if(prod) {
            document.getElementById('codigo').value = prod.codigo;
            document.getElementById('nombre').value = prod.nombre;
            document.getElementById('precioCompra').value = prod.precioCompra;
            document.getElementById('precioVenta').value = prod.precioVenta;
            document.getElementById('existencia').value = ''; 
            
            idEditando = prod.id;
            const modo = document.getElementById('modoInfo');
            modo.innerText = `üîÑ EDITANDO DATOS DE: ${prod.nombre}`;
            modo.style.display = 'block';
            
            const btn = document.getElementById('btnGuardar');
            btn.innerText = "Actualizar Datos";
            btn.className = "action-btn btn-orange";
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            mostrarSeccion('inventario');
        }
    }

    window.verificarProducto = function() {
        const cod = document.getElementById('codigo').value;
        const prod = inventarioLocal.find(j => j.codigo === cod);
        
        if(prod) {
            window.editarDesdeTabla(prod.id); // Reutilizamos la funci√≥n de editar
        } else {
            // Producto Nuevo
            idEditando = null;
            document.getElementById('modoInfo').style.display = 'none';
            document.getElementById('btnGuardar').innerText = "Guardar Nuevo Producto";
            document.getElementById('btnGuardar').className = "action-btn btn-green";
            // No limpiamos nombre/precio si el usuario ya escribi√≥ algo
        }
    }

    window.procesarIngreso = async function() {
        const c = document.getElementById('codigo').value;
        const n = document.getElementById('nombre').value;
        const pc = parseFloat(document.getElementById('precioCompra').value);
        const pv = parseFloat(document.getElementById('precioVenta').value);
        const st = parseInt(document.getElementById('existencia').value);

        if(!c || !n || isNaN(pc) || isNaN(pv)) return alert("Faltan datos obligatorios (C√≥digo, Nombre, Precios)");

        try {
            if(idEditando) {
                const old = inventarioLocal.find(j => j.id === idEditando);
                const cantidadAAgregar = isNaN(st) ? 0 : st; // Si no pone nada, suma 0
                const nuevoStock = old.existencia + cantidadAAgregar;
                
                await updateDoc(doc(db, "juguetes", idEditando), {
                    nombre: n, precioCompra: pc, precioVenta: pv, existencia: nuevoStock
                });
                
                if(cantidadAAgregar > 0 || pc !== old.precioCompra || pv !== old.precioVenta) {
                     await addDoc(colMovimientos, {
                         fecha: serverTimestamp(), nombre: n, accion: "ACTUALIZACI√ìN", 
                         detalle: `Stock: ${old.existencia}->${nuevoStock}. Precio: $${pv}`
                     });
                }
                alert("Producto Actualizado ‚úÖ");
            } else {
                if(isNaN(st)) return alert("Ingresa la cantidad inicial");
                if(inventarioLocal.some(j => j.codigo === c)) return alert("Ese c√≥digo ya existe");
                
                await addDoc(colJuguetes, { codigo: c, nombre: n, precioCompra: pc, precioVenta: pv, existencia: st });
                await addDoc(colMovimientos, { fecha: serverTimestamp(), nombre: n, accion: "NUEVO", detalle: `Inicio: ${st}` });
                alert("Producto Creado ‚úÖ");
            }
            limpiarInputs();
        } catch (e) { alert("Error: " + e.message); }
    }

    // 5. REPORTES Y EXPORTACI√ìN
    onSnapshot(query(colVentas, orderBy("fecha", "desc"), limit(30)), (snapshot) => {
        const tbody = document.getElementById("listaVentas");
        tbody.innerHTML = "";
        let sumaVenta = 0, sumaGanancia = 0;
        const hoy = new Date().toLocaleDateString();

        snapshot.forEach((doc) => {
            const v = doc.data();
            const f = v.fecha ? v.fecha.toDate() : new Date();
            const esHoy = f.toLocaleDateString() === hoy;
            
            let htmlDetalle = "";
            let total = 0, ganancia = 0;

            if(v.items) { // Ticket Nuevo
                total = v.totalTicket; ganancia = v.gananciaTicket || 0;
                v.items.forEach(i => htmlDetalle += `<div>‚Ä¢ ${i.nombre} <small>(x${i.cantidad})</small></div>`);
            } else { // Ticket Viejo
                total = v.total; ganancia = v.gananciaTotal || 0;
                htmlDetalle = `<div>‚Ä¢ ${v.nombreProducto} <small>(x${v.cantidad})</small></div>`;
            }

            if(esHoy) { sumaVenta += total; sumaGanancia += ganancia; }

            tbody.innerHTML += `
                <tr style="background:${esHoy?'#f0fff4':'white'}">
                    <td>${f.toLocaleDateString()}<br>${f.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
                    <td>${htmlDetalle}</td>
                    <td style="font-weight:bold">$${total.toFixed(2)}</td>
                </tr>`;
        });
        document.getElementById("totalDia").innerText = `$${sumaVenta.toFixed(2)}`;
        document.getElementById("gananciaDia").innerText = `$${sumaGanancia.toFixed(2)}`;
    });
    
    // MOVIMIENTOS
    onSnapshot(query(colMovimientos, orderBy("fecha", "desc"), limit(20)), (snap)=>{
        const tb=document.getElementById("listaMovimientos"); tb.innerHTML="";
        snap.forEach(d=>{ const m=d.data(); tb.innerHTML+=`<tr><td>${m.fecha?m.fecha.toDate().toLocaleDateString():''}</td><td>${m.nombre}</td><td>${m.accion}<br><small>${m.detalle}</small></td></tr>`; });
    });

    // EXPORTAR EXCEL
    window.exportarInventario = function() {
        let csv = "Codigo,Nombre,Stock,Costo,Venta,ValorCosto,ValorVenta\n";
        inventarioLocal.forEach(p => csv += `"${p.codigo}","${p.nombre}",${p.existencia},${p.precioCompra},${p.precioVenta},${p.existencia*p.precioCompra},${p.existencia*p.precioVenta}\n`);
        descargarCSV(csv, "Inventario_Completo.csv");
    }

    window.exportarVentas = async function() {
        if(!confirm("Descargar historial completo?")) return;
        const snaps = await getDocs(query(colVentas, orderBy("fecha", "desc")));
        let csv = "ID,Fecha,Hora,Producto,Cantidad,CostoUnit,VentaUnit,Subtotal,SubGanancia\n";
        snaps.forEach(doc => {
            const v = doc.data(); const f = v.fecha?v.fecha.toDate():new Date();
            if(v.items) {
                v.items.forEach(i => csv += `"${doc.id}","${f.toLocaleDateString()}","${f.toLocaleTimeString()}","${i.nombre}",${i.cantidad},${i.costoCompra},${i.precioVenta},${i.subtotal},${(i.precioVenta-i.costoCompra)*i.cantidad}\n`);
            } else {
                csv += `"${doc.id}","${f.toLocaleDateString()}","${f.toLocaleTimeString()}","${v.nombreProducto}",${v.cantidad},${v.costoUnitarioSnapshot},${v.precioVentaUnitario},${v.total},${v.gananciaTotal}\n`;
            }
        });
        descargarCSV(csv, "Reporte_Ventas_Detallado.csv");
    }

    function descargarCSV(content, name) {
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([content], {type:'text/csv;charset=utf-8;'}));
        link.download = name; link.click();
    }

    // UTILIDADES
    window.limpiarInputs = function() { 
        document.querySelectorAll('#inventario input').forEach(i => i.value = ''); 
        idEditando=null; 
        document.getElementById('modoInfo').style.display='none'; 
        document.getElementById('btnGuardar').innerText="Guardar Producto"; 
        document.getElementById('btnGuardar').className="action-btn btn-green";
    }
    
    window.filtrarInventarioLocal = function() { 
        const t = document.getElementById('buscador').value.toLowerCase(); 
        document.querySelectorAll('#tbodyInventario tr').forEach(r => r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); 
    }
    
    window.buscarYSeleccionar = function() { 
        const c = document.getElementById('buscadorVenta').value; 
        const f = inventarioLocal.find(j=>j.codigo===c); 
        if(f){ document.getElementById('selectProductoVenta').value=f.id; } 
    }
    
    window.mostrarSeccion = function(s){ 
        document.querySelectorAll('.section').forEach(x=>{x.classList.remove('active');x.style.display='none'}); 
        document.getElementById(s).style.display='block'; 
        document.getElementById(s).classList.add('active'); 
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
        event.target.classList.add('active'); 
    }

    // C√ÅMARA
    let sc; let inp;
    window.iniciarEscaneo=function(i){ 
        inp=i; 
        document.getElementById('reader').style.display='block'; 
        document.getElementById('btnStopScan').style.display='block'; 
        sc=new Html5Qrcode("reader"); 
        sc.start({facingMode:"environment"},{fps:10,qrbox:250},(t)=>{ 
            document.getElementById(inp).value=t; 
            detenerEscaneo(); 
            if(inp==='codigo') verificarProducto(); 
            if(inp==='buscadorVenta') window.buscarYSeleccionar(); 
        }); 
    }
    window.detenerEscaneo=function(){ 
        if(sc){ sc.stop().then(()=>{ 
            document.getElementById('reader').style.display='none'; 
            document.getElementById('btnStopScan').style.display='none'; 
            sc.clear(); 
        }); } 
    }
</script>
</body>
</html>