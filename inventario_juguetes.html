<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jugueter√≠a - Esc√°ner con C√°mara</title>
    <link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#1a73e8">

<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081840.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* ESTILOS (CSS) */
        body { font-family: sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #333; }
        
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; margin: 0 5px; cursor: pointer; background: #ddd; border: none; border-radius: 5px; font-size: 16px; }
        .tab-btn.active { background: #007bff; color: white; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; box-sizing: border-box; padding: 10px; height: 40px; border: 1px solid #ccc; border-radius: 5px; }
        
        /* Estilos para el input con bot√≥n de c√°mara */
        .input-group { display: flex; gap: 10px; }
        .btn-scan { background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 0 15px; font-size: 20px; }
        
        button.action-btn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 10px; }
        
        /* √Årea de la c√°mara */
        #reader { width: 100%; margin-bottom: 20px; display: none; border: 2px solid red; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        
        .section { display: none; }
        .section.active { display: block; }
        .low-stock { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>üß∏ Jugueter√≠a Camaya</h1>

    <div id="reader"></div>
    <button id="btnStopScan" onclick="detenerEscaneo()" style="display:none; width:100%; background:red; color:white; padding:10px; margin-bottom:10px;">Detener C√°mara</button>

    <div class="tabs">
        <button class="tab-btn active" onclick="mostrarSeccion('inventario')">Inventario</button>
        <button class="tab-btn" onclick="mostrarSeccion('venta')">Punto de Venta</button>
    </div>

    <div id="inventario" class="section active">
        
        <div class="form-group">
            <label>Buscar en inventario:</label>
            <div class="input-group">
                <input type="text" id="buscador" placeholder="Escribe o escanea..." onkeyup="filtrarInventario()">
                <button class="btn-scan" onclick="iniciarEscaneo('buscador')">üì∑</button>
            </div>
        </div>

        <h2>Nuevo Juguete</h2>
        <div class="form-group">
            <label>C√≥digo de Barras:</label>
            <div class="input-group">
                <input type="text" id="codigo" placeholder="Ej. 750123456">
                <button class="btn-scan" onclick="iniciarEscaneo('codigo')">üì∑</button>
            </div>
        </div>
        
        <div class="form-group"><input type="text" id="nombre" placeholder="Nombre del juguete"></div>
        <div class="form-group"><input type="text" id="descripcion" placeholder="Descripci√≥n breve"></div>
        <div class="form-group"><input type="number" id="precioCompra" placeholder="Precio de Compra ($)"></div>
        <div class="form-group"><input type="number" id="precioVenta" placeholder="Precio de Venta ($)"></div>
        <div class="form-group"><input type="number" id="existencia" placeholder="Cantidad inicial"></div>
        <button class="action-btn" onclick="agregarProducto()">Guardar Juguete</button>

        <h2>Lista de Productos</h2>
        <table id="tablaInventario">
            <thead>
                <tr><th>C√≥digo</th><th>Nombre</th><th>Stock</th><th>Precio</th><th>Acci√≥n</th></tr>
            </thead>
            <tbody id="listaProductos"></tbody>
        </table>
    </div>

    <div id="venta" class="section">
        <h2>Punto de Venta</h2>
        <div class="form-group">
            <label>Escanear para vender:</label>
            <div class="input-group">
                <input type="text" id="buscadorVenta" placeholder="Escanea aqu√≠..." onchange="buscarParaVenta()">
                <button class="btn-scan" onclick="iniciarEscaneo('buscadorVenta')">üì∑</button>
            </div>
        </div>

        <div class="form-group">
            <label>Producto Seleccionado:</label>
            <select id="selectProductoVenta"><option value="">-- Ninguno --</option></select>
        </div>
        <div class="form-group"><label>Cantidad:</label><input type="number" id="cantidadVenta" value="1" min="1"></div>
        <button class="action-btn" style="background-color: #007bff;" onclick="realizarVenta()">Confirmar Venta</button>
    </div>
</div>

<script>
    // --- L√ìGICA DE C√ÅMARA ---
    let html5QrcodeScanner;
    let inputDestinoActual = '';

    function iniciarEscaneo(idInputDestino) {
        inputDestinoActual = idInputDestino;
        document.getElementById('reader').style.display = 'block';
        document.getElementById('btnStopScan').style.display = 'block';

        html5QrcodeScanner = new Html5Qrcode("reader");
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        // Preferir c√°mara trasera
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
    }

    function onScanSuccess(decodedText, decodedResult) {
        // Reproducir sonido beep (opcional)
        // let audio = new Audio('beep.mp3'); audio.play(); 

        // Poner el texto en el input correspondiente
        document.getElementById(inputDestinoActual).value = decodedText;
        
        // Acciones autom√°ticas seg√∫n donde estemos
        if(inputDestinoActual === 'buscador') filtrarInventario();
        if(inputDestinoActual === 'buscadorVenta') buscarParaVenta();

        detenerEscaneo();
        alert("C√≥digo detectado: " + decodedText);
    }

    function onScanFailure(error) {
        // No hacer nada, la librer√≠a reporta errores constantemente mientras busca
    }

    function detenerEscaneo() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('reader').style.display = 'none';
                document.getElementById('btnStopScan').style.display = 'none';
                html5QrcodeScanner.clear();
            }).catch(err => console.error("Error al detener", err));
        }
    }

    // --- L√ìGICA DE INVENTARIO (Igual que antes) ---
    let inventario = JSON.parse(localStorage.getItem('inventarioJuguetes')) || [];
    actualizarVista(inventario);

    function agregarProducto() {
        const codigo = document.getElementById('codigo').value;
        const nombre = document.getElementById('nombre').value;
        const descripcion = document.getElementById('descripcion').value;
        const pCompra = parseFloat(document.getElementById('precioCompra').value);
        const pVenta = parseFloat(document.getElementById('precioVenta').value);
        const existencia = parseInt(document.getElementById('existencia').value);

        if(codigo && nombre && pVenta) {
            if(inventario.some(p => p.codigo === codigo)) {
                alert("C√≥digo ya existe."); return;
            }
            const nuevo = { id: Date.now(), codigo, nombre, descripcion, precioCompra: pCompra, precioVenta: pVenta, existencia };
            inventario.push(nuevo);
            guardarDatos(); limpiarFormulario(); actualizarVista(inventario);
            alert("Guardado!");
        } else { alert("Faltan datos."); }
    }

    function filtrarInventario() {
        const texto = document.getElementById('buscador').value.toLowerCase();
        const lista = inventario.filter(p => p.nombre.toLowerCase().includes(texto) || p.codigo.toLowerCase().includes(texto));
        actualizarVista(lista);
    }

    function buscarParaVenta() {
        const codigo = document.getElementById('buscadorVenta').value;
        const producto = inventario.find(p => p.codigo === codigo);
        if(producto) {
            document.getElementById('selectProductoVenta').value = producto.id;
            // No borramos el c√≥digo inmediatamente para que el usuario vea qu√© escane√≥
        }
    }

    function realizarVenta() {
        const id = parseInt(document.getElementById('selectProductoVenta').value);
        const cant = parseInt(document.getElementById('cantidadVenta').value);
        const idx = inventario.findIndex(p => p.id === id);

        if (idx > -1 && inventario[idx].existencia >= cant) {
            inventario[idx].existencia -= cant;
            guardarDatos(); actualizarVista(inventario);
            alert(`Venta: $${inventario[idx].precioVenta * cant}`);
            document.getElementById('cantidadVenta').value = 1;
            document.getElementById('buscadorVenta').value = ''; // Limpiar buscador
        } else { alert("Error en venta."); }
    }

    function guardarDatos() { localStorage.setItem('inventarioJuguetes', JSON.stringify(inventario)); }
    
    function actualizarVista(lista) {
        const tbody = document.getElementById('listaProductos'); tbody.innerHTML = '';
        lista.forEach(p => {
            tbody.innerHTML += `<tr><td>${p.codigo}</td><td>${p.nombre}</td><td class="${p.existencia<5?'low-stock':''}">${p.existencia}</td><td>$${p.precioVenta}</td><td><button onclick="eliminar(${p.id})">‚ùå</button></td></tr>`;
        });
        
        const select = document.getElementById('selectProductoVenta');
        const prev = select.value;
        select.innerHTML = '<option value="">-- Elegir --</option>';
        inventario.forEach(p => select.innerHTML += `<option value="${p.id}">${p.nombre} ($${p.precioVenta})</option>`);
        select.value = prev;
    }

    function eliminar(id) {
        if(confirm('¬øBorrar?')) { inventario = inventario.filter(p => p.id !== id); guardarDatos(); actualizarVista(inventario); }
    }
    
    function limpiarFormulario() {
        document.querySelectorAll('#inventario input').forEach(i => i.value = '');
    }

    function mostrarSeccion(sec) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(sec).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(sec === 'inventario') document.querySelector('.tabs button:nth-child(1)').classList.add('active');
        else document.querySelector('.tabs button:nth-child(2)').classList.add('active');
    }
</script>

</body>
</html>